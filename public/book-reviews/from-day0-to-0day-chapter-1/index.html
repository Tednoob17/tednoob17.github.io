<!DOCTYPE html>
<html lang="en">

    <head><title>From Day 0 to 0day Chapter 1 &ndash; Tedsig42</title>
<meta name="description" content="Another infosec enthusiast blog">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="https://tednoob17.github.io/css/palettes/tokyo-night-dark.css" id="theme-css">
<link rel="stylesheet" href="https://tednoob17.github.io/css/risotto.css">
<link rel="stylesheet" href="https://tednoob17.github.io/css/custom.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  const themeToggle = document.getElementById('theme-toggle');
  const themeCss = document.getElementById('theme-css');
  const darkTheme = "tokyo-night-dark";
  const lightTheme = "tokyo-night-light";

  
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
     themeCss.href = themeCss.href.replace(/(.*css\/palettes\/)(.*)(\.css)/, '$1' + savedTheme + '$3');
  }

  if (themeToggle) {
    themeToggle.addEventListener('click', function(e) {
      e.preventDefault();
      const currentHref = themeCss.href;
      const isDark = currentHref.includes(darkTheme) || currentHref.includes('dark');
      const newTheme = isDark ? lightTheme : darkTheme;

      themeCss.href = themeCss.href.replace(/(.*css\/palettes\/)(.*)(\.css)/, '$1' + newTheme + '$3');
      localStorage.setItem('theme', newTheme);
    });
  }

  
  const searchTrigger = document.getElementById('search-trigger');
  const searchOverlay = document.getElementById('search-overlay');
  const searchClose = document.getElementById('search-close');
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  let searchIndex = null;

  if (searchTrigger) {
    searchTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        searchOverlay.style.display = 'block';
        searchInput.focus();

        if (!searchIndex) {
            fetch('https:\/\/tednoob17.github.io\/index.json')
                .then(response => response.json())
                .then(data => {
                    searchIndex = data;
                });
        }
    });
  }

  if (searchClose) {
    searchClose.addEventListener('click', function() {
        searchOverlay.style.display = 'none';
    });
  }

  if (searchInput) {
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }

        if (searchIndex) {
          const results = searchIndex.filter(item => {
              return item.title.toLowerCase().includes(query) || item.content.toLowerCase().includes(query);
          });

          let html = '';
          if (results.length > 0) {
              html = '<ul style="list-style: none; padding: 0;">';
              results.slice(0, 10).forEach(result => {
                  html += `<li style="margin-bottom: 10px;"><a href="${result.permalink}" style="color: white; font-size: 1.2em; text-decoration: none; border-bottom: 1px solid #555; display: block; padding: 5px;">${result.title}</a></li>`;
              });
              html += '</ul>';
          } else {
              html = '<p>No results found.</p>';
          }
          searchResults.innerHTML = html;
        }
    });
  }
});
</script>



<link rel="icon" href="https://0xswitch.fr//static/img/gif/main-5.gif">

</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
      <li class="nomarker"><h1 class="page__logo"><a href="https://tednoob17.github.io/" class="page__logo-inner">Tedsig42</a></h1></li>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/about/" title="">About</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/posts/" title="">Posts</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/friends/" title="">Friends</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/music/" title="">Music</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/art/" title="">Art</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/blogs/" title="">Blogs</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/book-reviews/" title="">Book Review</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://tednoob17.github.io/contact/" title="">Contact</a></li>
    
    <li class="main-nav__item">
      <a class="nav-main-item" href="#" id="theme-toggle" title="Toggle Theme">
        <i class="fas fa-adjust"></i>
      </a>
    </li>
    <li class="main-nav__item">
      <a class="nav-main-item" href="#" id="search-trigger" title="Search">
        <i class="fas fa-search"></i>
      </a>
    </li>
    </ul>
</nav>

<div id="search-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 50px; overflow-y: auto;">
  <div style="max-width: 600px; margin: 0 auto; color: white;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Search</h2>
      <button id="search-close" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
    <input type="text" id="search-input" placeholder="Type to search..." style="width: 100%; padding: 10px; font-size: 18px; margin-bottom: 20px; color: black;">
    <div id="search-results"></div>
  </div>
</div>
</header>

            <section class="page__body">
    <header class="content__header">
        <h1>From Day 0 to 0day Chapter 1</h1>
    </header>
    <div class="content__body">
        <p><img src="/images/stc/chap2-intro.jpeg" alt="alt"></p>
<h2 id="introduction">Introduction</h2>
<h2 id="taint-analysis">Taint Analysis</h2>
<p><strong>Life is not like water. Things in life don’t necessarily flow over the shortest possible route</strong> <code>Haruki Murakami - 1Q84</code></p>
<p><strong>Taint analysis</strong>  (or <strong>source and sink analysis</strong> ) is the analysis of the flow of <strong>input</strong>  through a <strong>program</strong>  from <strong>sources to sinks</strong> .</p>
<p>It relies on a simple idea: a large number of vulnerabilities occur because attacker <strong>controlled input</strong> (the <strong>source</strong>) flows to a dangerous <strong>function</strong>  (the <strong>sink</strong>).
If the input modifies other variables along the way, these
variables become &ldquo;<strong>tainted</strong>&rdquo; and are included in the analysis.</p>
<p>If the code later uses those tainted variables to modify others, those variables are also tainted, and so on. This is known as <strong>taint propagation</strong>.</p>
<h3 id="buffer-overflow">Buffer Overflow</h3>
<p>In my laptop with or without <code>-fstack-protector</code> it display   <code>stack smashing detected</code> so it detect buffer overflow when i run a exploit script</p>
<p>Applying Taint Analysis<br>
First, identify the source.
For what is see here the user not directly controls input, but we have to function the main who use <code>argc and argv</code>  (who are really not used in the code), and the second function  <code>handleClient</code> who use a variable passed to parameters who is call  in main function. The variable <code>clientSocket</code> is used two time in the code and where we have problem is line <strong>19</strong> .
<code>while ((bytesRead = recv(clientSocket, buffer, MAX_BUFFER_SIZE, 0)) &gt; 0) </code>
Next, identify the sink, a dangerous function that could cause negative
outcomes like memory corruption if an attacker controls its inputs
This is line <strong>20</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(finalBuffer <span style="color:#f92672">+</span> offset, buffer, bytesRead);
</span></span></code></pre></div><p><img src="/images/stc/ch1-code_1.png" alt="alt">
1 - Is the variables who is incremented and increase the  memory allocated.<br>
2 - It the line who create a buffer overflow due to the memory copy done here.<br>
3 - It&rsquo;s the  where the problem born with the limited buffer size.</p>
<ul>
<li>Now in main function :
<img src="/images/stc/ch1-code_2.png" alt="alt"></li>
</ul>
<p>1- The vulnerable function is used only one time, but the variable passed to parameters not.<br>
2- The <code>clientSocket</code> variable is used for accept value from connection create  in (<strong>3</strong>)<br>
3 - The connection is create here and is listen in (<strong>4</strong>)<br>
4 - The connection is listen here , the value is send to connection waiting like <strong>input</strong> , and the value is send to <code>handleClient</code> .</p>
<p>So the exploit code is here :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>gethostname()
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>sendall(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p><strong>Result:</strong><br>
<img src="/images/stc/ch1-code_3.png" alt="alt"></p>
<h3 id="applying-taint-analysis">Applying Taint Analysis</h3>
<p>First, identify the <strong>source</strong>. This should be the output of a function that
retrieves and stores attacker-controlled input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>bytesRead <span style="color:#f92672">=</span> <span style="color:#a6e22e">recv</span>(clientSocket, buffer, MAX_BUFFER_SIZE, <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>Next, identify the <strong>sink</strong>, a dangerous function that could cause negative
outcomes like memory corruption if an attacker controls its inputs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(finalBuffer <span style="color:#f92672">+</span> offset, buffer, bytesRead);
</span></span></code></pre></div><p>We must trace the flow of tainted variables from the first to the last.<br>
Any others variables who is affected by a tainted variable is also <strong>tainted</strong> . This can conduct to <strong>path explosion</strong> .<br>
Path explosion refers to the fact that the number of <a href="https://en.wikipedia.org/wiki/Control_flow" title="Control flow">control-flow</a> paths in a program <a href="https://en.wikipedia.org/wiki/Exponential_growth" title="Exponential growth">grows exponentially</a> (&ldquo;explodes&rdquo;) with an increase in program size and can even be infinite in the case of programs with unbounded loop iterations (<a href="https://en.wikipedia.org/wiki/Path_explosion">Source Wikipedia</a>).<br>
This makes it impossible, or at least extremely time-consuming, to apply taint analysis to all possible paths in a complex target.</p>
<p>We have here 70 lines so we not worry about path explosion.</p>
<h2 id="sink-to-source-analysis">Sink-to-Source Analysis</h2>
<p>Don&rsquo;t forget that  <strong>controlled input</strong> (the <strong>source</strong>) flows to a dangerous <strong>function</strong>  (the sink).<br>
Liveoverflow video helped me to make a summary of any things (<a href="https://youtu.be/ZaOtY4i5w_U">https://youtu.be/ZaOtY4i5w_U</a>)<br>
<img src="/images/stc/ch1-code_4.png" alt="alt">
While the <strong>source-to-sink</strong> approach favors completeness, <strong>sink-to-source analysis</strong>  favors selection.
As you saw, taking the most obvious route in taint analysis, starting from input sources and working your way through the code,
leads to exponentially branching paths of tainted variables that are impossible to follow.</p>
<h3 id="summary-0">Summary 0</h3>
<p>While the source-to-sink approach favors completeness, sink-to-source analysis favors selection.</p>
<ul>
<li>
<p><strong>Source-to-sink analysis favors completeness:</strong> This approach starts from all potential <em>sources</em> of data (user input, network connections, file reads) and traces how that data propagates through the system until it reaches <em>sinks</em> (database queries, file writes, display to user, command execution). The goal is to identify <strong>all possible paths</strong> that data can take, even if they are very indirect. This is crucial for finding vulnerabilities where untrusted data could eventually reach a sensitive operation without proper sanitization or validation. Because it aims to be exhaustive, it might generate more &ldquo;false positives&rdquo; (paths that are theoretically possible but might not be exploitable in practice).</p>
</li>
<li>
<p><strong>Sink-to-source analysis favors selection (or relevance):</strong> This approach starts from a specific <em>sink</em> (a sensitive operation that you want to protect) and traces backward to identify <strong>what sources</strong> could feed data into that sink. The goal here is to determine <em>which inputs</em> could influence a particular sensitive operation. This is useful for prioritizing analysis, focusing on the most critical parts of the code, and reducing the number of irrelevant findings. It&rsquo;s more targeted and thus &ldquo;selective.&rdquo;<br>
<strong>Total</strong> :</p>
</li>
<li>
<p><strong>Source-to-sink:</strong> &ldquo;Where can this potentially bad data go?&rdquo; (Broad, comprehensive)</p>
</li>
<li>
<p><strong>Sink-to-source:</strong> &ldquo;What data can influence this sensitive operation?&rdquo; (Targeted, selective)</p>
</li>
</ul>
<h3 id="choosing-the-right-sinks">Choosing the Right Sinks</h3>
<p>The first step is to select the <strong>sink patterns</strong> that you want to work backward
from. You can refer to <strong>banned function</strong> lists maintained by other developers to discover common dangerous sinks and how to exploit them. or example,
Microsoft actively updates the list of banned functions that it integrates in its
code analysis tools <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/28719-banned-api-usage-use-updated-function-replacement">Microsoft baneed function</a>.</p>
<p>In addition to the standard library functions like <code>memcpy</code>, analyze the
source code carefully to identify wrapper functions that may help simplify
your analysis. Developers often append <code>_copy</code> or <code>_memcpy</code> to the names of these
wrapper functions.<br>
Wait, wait, what is wrappers ?</p>
<hr>
<p>The term &ldquo;wrapper&rdquo; in computer science, and specifically in programming, refers to a piece of code (which can be a function, a class, or even an entire program) that &ldquo;encapsulates&rdquo; or &ldquo;wraps around&rdquo; another piece of code, a data structure, or an external system.<br>
Think of it like this:</p>
<ul>
<li>A gift wrapper: You wrap a gift to make it look nicer, protect it, and provide a convenient way to present it. The wrapper itself isn&rsquo;t the gift, but it makes the gift more presentable and manageable.</li>
<li>A universal adapter for electronics: You have a device with a specific plug, and you want to use it in a country with different outlets. A universal adapter &ldquo;wraps&rdquo; the device&rsquo;s plug, allowing it to connect to the new outlet without changing the device&rsquo;s original plug.</li>
</ul>
<hr>
<p><strong>Ex</strong> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_simple_wrapper</span>(func):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inner_function</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Calling function: </span><span style="color:#e6db74">{</span>func<span style="color:#f92672">.</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Finished calling function: </span><span style="color:#e6db74">{</span>func<span style="color:#f92672">.</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> inner_function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">greet</span>(name):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello, </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Manually wrapping the function</span>
</span></span><span style="display:flex;"><span>wrapped_greet <span style="color:#f92672">=</span> my_simple_wrapper(greet)
</span></span><span style="display:flex;"><span>print(wrapped_greet(<span style="color:#e6db74">&#34;Alice&#34;</span>))
</span></span></code></pre></div><p><strong>Output</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Calling <span style="color:#66d9ef">function</span>: greet
</span></span><span style="display:flex;"><span>Finished calling <span style="color:#66d9ef">function</span>: greet
</span></span><span style="display:flex;"><span>Hello, Alice!
</span></span></code></pre></div><p>Another factor in deciding which wrapper functions to include in your
analysis is how many times the functions are used. If they include too much
custom logic that applies only to rare cases, they cease to be useful.<br>
By Example if a wrapper function is used (is call) only once in all codebase it not important. As a general rule, consider wrapper functions as sinks when they’re reused extensively relative to the total size of the codebase.</p>
<h3 id="filtering-for-exploitable-scenarios">Filtering for Exploitable Scenarios</h3>
<p>After selecting your sinks, begin tracing the flow of tainted variables
backward from the sinks.</p>
<p><strong>Null dereference:</strong> When the code tries to access data at an invalid null
address, leading to crashes. For <code>memcpy</code>, this occurs when <code>dest</code> or <code>src</code> is a <strong>null pointer</strong>.
<em><strong>Buffer overflow:</strong></em> When the code writes beyond the size of <code>dest</code>. This
can occur when n is larger than the <code>size</code> of <code>dest</code>.</p>
<p><strong>Information leak:</strong> When the code reads data from addresses that is not
intended to be exposed. This occurs when <code>n</code> is larger than <code>src</code>.</p>
<p><strong>Memory corruption:</strong> When the code makes unintended changes to
memory, which can occur if <code>dest</code> and <code>src</code> overlap.</p>
<p>Ex :<br>
On <code>platform/centec-arm64/tsingma-bsp/src/ctcmac/ctcmac.c</code> (on local) or <a href="https://github.com/sonic-net/sonic-buildimage/blob/bb3362760d01055d1c30cbda8ec3bf5ea4f5d7aa/platform/centec-arm64/tsingma-bsp/src/ctcmac/ctcmac.c">sonic-buildimage-old-commit</a> .</p>
<p><img src="/images/stc/ch1-code_5.png" alt="alt"></p>
<ul>
<li>5 : Starting from the first argument, <code>tx_buff-&gt;vaddr + offset</code> (5) , which corresponds to the destination buffer for <code>memcpy</code> function .</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">memcpy</span>(<span style="color:#66d9ef">void</span> dest[<span style="color:#66d9ef">restrict</span> .n], <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> src[<span style="color:#66d9ef">restrict</span> .n], <span style="color:#66d9ef">size_t</span> n);
</span></span><span style="display:flex;"><span><span style="color:#75715e"># on man memcpy
</span></span></span></code></pre></div><ul>
<li>2 : Work backward to where <code>tx_buff-&gt;vaddr</code> is first assigned the return value of <code>kmalloc(alloc_size, GFP_KERNEL)</code> (2)
This warrants greater attention because <a href="https://litux.nl/mirror/kerneldevelopment/0672327201/ch11lev1sec4.html">kmalloc</a>  allocates <strong>kernel memory</strong>, corruption of which could be devastating.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">kmalloc</span>(<span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">int</span> flags)
</span></span></code></pre></div><p><img src="/images/stc/ch1-code_6.png" alt="alt"></p>
<ul>
<li>
<p>1 : The <strong>size</strong> of the <strong>buffer allocated</strong> to <code>tx_buff-&gt;vaddr</code> is<code> alloc_size</code>, set by the cryptic macro <code>ALIGN(skb-&gt;len, BUF_ALIGNMENT)</code> (1) .</p>
</li>
<li>
<p>3 : Before figuring out what this macro does, examine the value assigned to offset   (3 ), which also appears in the first argument to <code>memcpy</code> later on.</p>
</li>
<li>
<p>4 : Because the  ((<code>u64</code>) <code>tx_buff-&gt;vaddr</code>) &amp; (<code>BUF_ALIGNMENT - 1</code>) <strong>bitwise</strong> <strong>AND</strong> <strong>operation</strong>  (&amp;) ensures that the result has a <strong>maximum value</strong> of <code>BUF_ALIGNMENT - 1</code> , offset must range from 1 to <code>BUF_ALIGNMENT</code>.
The next if conditional block 1 moves this range down to 0 to <code>BUF_ALIGNMENT - 1</code> , since it will be reassigned the value <code>0</code> if it equals <code>BUF_ALIGNMENT</code>.
In short, the destination address for <code>memcpy</code> ranges from</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>tx_buff<span style="color:#f92672">-&gt;</span>vaddr to tx_buff<span style="color:#f92672">-&gt;</span>vaddr <span style="color:#f92672">+</span> (BUF_ALIGNMENT <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>).
</span></span></code></pre></div><p>in (5) .</p>
<p>Additionally, because the buffer at <code>tx_buff-&gt;vaddr</code> is of <strong>size</strong>
<code>ALIGN(skb-&gt;len, BUF_ALIGNMENT)</code> on (2), or at least <code>BUF_ALIGNMENT</code> bytes, it isn’t possible for <code>tx_buff-&gt;vaddr + offset</code> to exceed the allocated buffer.</p>
<p>Thus, you can safely ignore the first argument to the <code>memcpy</code> call in your taint analysis because it will never be dangerous by itself. Instead, focus on the third argument, which determines the number of bytes copied into the buffer and could potentially cause an overflow.</p>
<p>This process demonstrates a big advantage of sink-to-source analysis:<br>
By checking whether a sink is exploitable from the beginning, you can decide which paths are relevant instead of chasing down every rabbit hole.<br>
Furthermore, eliminating one potential <strong>attack vector</strong> at the <strong>sink</strong> allows you to eliminate similar <strong>patterns</strong> elsewhere.</p>
<p>For example, because the same <code>memcpy(tx_buff-&gt;vaddr + offset, ...);</code> pattern appears in <code>frag_to_txbuff_alloc</code> and <code>skb_to_txbuff_alloc</code>, you can skim those instances instead of repeating the analysis. Remember that <strong>sink-to-source</strong> tracing <strong>prioritizes selection</strong>, while <strong>source-to-sink</strong> tracing prioritizes <strong>completeness</strong>.</p>
<ul>
<li>
<p><strong>frag_to_txbuff_alloc</strong>
<img src="/images/stc/ch1-code_7.png" alt="alt"></p>
</li>
<li>
<p><strong>skb_to_txbuff_alloc</strong>
<img src="/images/stc/ch1-code_8.png" alt="alt"></p>
</li>
</ul>
<p>Fortunately, not all instances of filtering <strong>sinks</strong> require as much depth.
Consider the following instances of memcpy in <code>platform/barefoot/bfn-modules/modules/bf_tun.c</code> :</p>
<ul>
<li><code>memcpy(cmd, &amp;tun-&gt;link_ksettings, sizeof(*cmd));</code><br>
It uses sizeof to ensure the number of bytes copied into the cmd buffer matches its size
<img src="/images/stc/ch1-code_9.png" alt="alt"></li>
<li><code>memcpy(filter-&gt;addr[n], addr[n].u, ETH_ALEN);</code><br>
It uses a fixed constant value for the number of bytes and thus is not attacker-controllable.
<img src="/images/stc/ch1-code_10.png" alt="alt">
Observe how many false positives you can filter out by locating all instances of <code>memcpy</code> in the code, then removing instances of non-vulnerable
uses of <code>memcpy</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>╭─sig42@x76 ~/Downloads/sonic-buildimage/src ‹bcf5388f2●›
</span></span><span style="display:flex;"><span>╰─$ grep -r <span style="color:#e6db74">&#34;memcpy&#34;</span> --include<span style="color:#f92672">=</span><span style="color:#ae81ff">\*</span>.<span style="color:#f92672">{</span>c,cpp<span style="color:#f92672">}</span> . | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">237</span>
</span></span></code></pre></div><p>This command searches all files with a <code>.c</code> or <code>.cpp</code>  file extension for
the <code>memcpy</code> string, returning <strong>237</strong> results.<br>
Next, tweak the regular expression to match instances of <code>memcpy</code> that
don’t use a constant for the third argument, based on the assumption that
constant values either are numeric or have variable names in all capital
letters:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>╭─sig42@x76 ~/Downloads/sonic-buildimage/src ‹bcf5388f2●›
</span></span><span style="display:flex;"><span>╰─$ grep -r <span style="color:#e6db74">&#34;memcpy(.*,.*, [a-z]&#34;</span> --include<span style="color:#f92672">=</span><span style="color:#ae81ff">\*</span>.<span style="color:#f92672">{</span>c,cpp<span style="color:#f92672">}</span> . | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">97</span>
</span></span></code></pre></div><p>This regex uses <code>[a-z]</code>  to ensure that the third argument starts with a lowercase letter, returning <strong>97</strong> results. This cuts down the number of results you have to manually analyze by more than half!</p>
<p>Next, filter out instances where the third argument is sizeof(dest):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>╭─sig42@x76 ~/Downloads/sonic-buildimage/src ‹bcf5388f2●›
</span></span><span style="display:flex;"><span>╰─$ grep -r <span style="color:#e6db74">&#34;memcpy(.*,.*, [a-z]&#34;</span> --include<span style="color:#f92672">=</span><span style="color:#ae81ff">\*</span>.<span style="color:#f92672">{</span>c,cpp<span style="color:#f92672">}</span> . | grep -v <span style="color:#e6db74">&#34;memcpy(.*,.*,\s*sizeof(&#34;</span> | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">54</span>
</span></span></code></pre></div><p>As shown here, instead of overcomplicating the <strong>regex</strong>, you can simply
pipe the results of the first grep command to a second grep command, which
uses the <code>-v</code> option to filter out results that match the <strong>regex pattern</strong>.<br>
The pattern finds <code>memcpy</code> calls whose third argument starts with sizeof(, disregarding
any leading spaces. (space beetween <code>*,</code>  and  <code>[a-z]</code>) .<br>
For manual <strong>code review</strong>, focus your time and energy on quickly filtering out non-exploitable scenarios to speed up sink-to-source tracing.</p>
<h3 id="confirming-exploitability">Confirming Exploitability</h3>
<p>Taking note of additionnal non-exploitable functions like <code>strlen</code> or <code>sizeof </code> used in third  parameters of <code>memcpy</code> .   This means that the number of bytes copied likely matches the size of the destination buffer.</p>
<p><img src="/images/stc/ch1-code_11.png" alt="alt"></p>
<ul>
<li>6 :  Here the six is not exploitation because of the previous exclusions because of exclusion i talk previously.</li>
<li>4 : For know if the buffer overflow is exploitation here it&rsquo;s important to determine the size of  <code>current_buffer_position</code> , her last value was assigned to line (2) <code>auto current_buffer_position = buffer</code> and <code>buffer</code> was declared to line (1)
<code>static uint8_t buffer[4096]</code> , know we know that the <strong>destination buffer</strong> has a fixed size 4096 bytes</li>
<li>5 : Here the problem is that it can provoke a buffer overflow if her value is superior of the size of (4), the <code>ntohs</code>  function converts the <strong>unsigned short integer</strong> <code>netshort</code> from network byte order to host byte order.  Continue tracing back from <code>option-optin_length</code> , we can see that the <code>option</code> is set by the function <code>parse_dhcpv6_opt</code> . This function is defined earlier in the file:</li>
</ul>
<p><img src="/images/stc/ch1-code_12.png" alt="alt"></p>
<ul>
<li>The buffer variable is parser by a <code>dhcpv6_option</code> struct who is defined in <code>src/dhcp6relay/src/relay.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> dhcpv6_option {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint16_t</span> option_code;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint16_t</span> option_length;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>The type of <code>option_length</code> is <code>uint16_t</code> who is a (unisgned short integer) with <strong>65535</strong> for max value.<br>
Noted that we can choose the value used by
<code>option-&gt;option_length</code> but the value of <strong>buffer destination</strong>  (<code>current_buffer_position</code>) is fixed to <strong>4096</strong>.<br>
So this function is <strong>exploitable</strong> .</p>
<h3 id="identifying-an-attacker-controlled-source">Identifying an Attacker-Controlled Source</h3>
<p>After finding an exploitable sink pattern, work backward in the code to con-
firm if it is reachable from an attacker-controlled source.
At this point, you’ve confirmed three important points in the taint flow:</p>
<ol>
<li>A sink exists at the first <code>memcpy</code> call in the <code>relay_relay_reply function</code>.</li>
<li>This sink is exploitable if <code>option-&gt;option_length</code> is larger than <strong>4096</strong>.</li>
<li>The <code>option-&gt;option_length</code> parameter has a maximum value of <strong>65535</strong>.</li>
</ol>
<p>Now making sure there are no exploit-killing sanitization or validation steps along the way. Before the <code>memcpy</code> we have a <code>switch</code> case :</p>
<ul>
<li>The switch case execute this part of code if <code>ntohs(option-&gt;option_code))</code> , in the <code>src/dhcp6relay/src/relay.h </code> file reveals that <code>OPTION_RELAY_MESSAGE</code> corresponds to <code>9</code>.</li>
<li>The <code>option</code> variable is a instance of <code>dhcpv6_option</code> struct parsed from
the bytes at the <code>current_position</code> pointer while <code>(current_position - msg) != len</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> option <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_dhcpv6_opt</span>(current_position, <span style="color:#f92672">&amp;</span>tmp);
</span></span></code></pre></div><p>Why ? because of <code>parse_dhcpv6_opt</code> is  a function who return a <code>dhcpv6_option</code> struct and also because option have <code>option_code</code> and <code>option_length</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">╭─</span>sig42<span style="color:#960050;background-color:#1e0010">@</span>x76 <span style="color:#f92672">~/</span>Downloads<span style="color:#f92672">/</span>sonic<span style="color:#f92672">-</span>buildimage <span style="color:#960050;background-color:#1e0010">‹</span>bcf5388f2<span style="color:#960050;background-color:#1e0010">●›</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">╰─$</span> grep <span style="color:#f92672">-</span>A <span style="color:#ae81ff">10</span> <span style="color:#e6db74">&#34;dhcpv6_option&#34;</span> src<span style="color:#f92672">/</span>dhcp6relay<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>relay.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> dhcpv6_option {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> option_code;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> option_length;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li><code>msg</code> argument is a pointer to the <strong>DHCPv6</strong> message header position and the <code>len</code> argument  is the <strong>size</strong> of data received (Refer to function annotation).</li>
<li>Moreover, <code>current_position</code> is initialized as msg
and incremented by the size of a dhcpv6_relay_msg struct:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>current_position <span style="color:#f92672">+=</span><span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> dhcpv6_relay_msg).
</span></span></code></pre></div><ul>
<li>
<p><code>parse_dhcpv6_opt</code> takes <code>current_position</code> as its first argument. <code>current_position</code> is a pointer (<code>const uint8_t *</code>) that indicates the beginning of the bytes to be interpreted.</p>
</li>
<li>
<p>As the <code>relay_relay_reply</code> function progresses through the received message, <code>current_position</code> is updated to point to the beginning of the next option or the next data segment to be processed. This is the role of <code>current_position = tmp;</code> after the call to <code>parse_dhcpv6_opt</code>.</p>
</li>
<li>
<p>The <code>current_position</code> pointer does not point to a separate copy of the message. It points directly into the original <code>msg</code> that was passed as an argument to the <code>relay_relay_reply</code> function.</p>
</li>
<li>
<p><code>msg</code> is the raw buffer that contains the entire DHCPv6 message received from the network. Therefore, <code>current_position</code> is simply an offset (an advanced pointer) within this initial <code>msg</code>.</p>
</li>
<li>
<p>you can deduce that current_position during <code>parse_dhcpv6_opt</code> is located in the <code>msg</code> bytes at this offset</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <strong>Packet Schema</strong></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>msg                                     current_position                                              len
</span></span><span style="display:flex;"><span>------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>| dhcpv6_relay_msg         |  dhcpv6_option        |  dhcpv6_msg    |                  |             |            
</span></span><span style="display:flex;"><span>+----------------------------------------------------------------------------------------------------+
</span></span></code></pre></div><ul>
<li>After determining that the attacker must control <code>msg</code> (the second argument to <code>relay_relay_reply</code>) to reach the vulnerable <code>memcpy</code>, look for calls to <code>relay_relay_reply</code> to determine the source of the second argument.</li>
</ul>
<p>This function is only used in one function on <code>server_callback</code>
<img src="/images/stc/ch1-code_13.png" alt="alt"><br>
The variable <code>message_buffer</code> is passed to second argument of <code>relay_relay_reply</code>, but for reached the <code>memcpy</code> in <strong>if</strong> statement , it crucial to control the <code>msg</code> variable who fortunately  have <code>message_buffer</code> who was be affected to <code>msg</code>.</p>
<p>After that we can see the line containing the first <strong>if</strong> statement who   reads data directly from the network socket (<code>config-&gt;local_sock</code>) and stores it into <code>message_buffer</code>. And the <code>config</code> variable contain <code>arg</code> argument passed to <code>server_callback</code> function.</p>
<h2 id="confirming-a-reachable-attack-surface">Confirming a Reachable Attack Surface</h2>
<p>We need to confirm whether the source itself is reachable by an attacker.
We know that <code>recvfrom</code> function open socket and copy data to <code>config-&gt;local_sock</code>
from <code>message_buffer</code> .
Multiple possibility are offer here, by example  a remote attacker can access to socket when <code>recvfrom</code> is open .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─sig42@x76 ~/Downloads/sonic-buildimage/src ‹bcf5388f2●› 
</span></span><span style="display:flex;"><span>╰─$ grep -ni <span style="color:#e6db74">&#34;config-&gt;local_sock&#34;</span> dhcp6relay/src/relay.cpp
</span></span><span style="display:flex;"><span>317:    interface_config-&gt;local_sock <span style="color:#f92672">=</span> *local_sock; 
</span></span><span style="display:flex;"><span>573:    relay_client<span style="color:#f92672">(</span>config-&gt;local_sock, current_position, ntohs<span style="color:#f92672">(</span>udp_header-&gt;len<span style="color:#f92672">)</span> - sizeof<span style="color:#f92672">(</span>udphdr<span style="color:#f92672">)</span>, ip_header, ether_header, config<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>594:    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>data <span style="color:#f92672">=</span> recvfrom<span style="color:#f92672">(</span>config-&gt;local_sock, message_buffer, 4096, 0, <span style="color:#f92672">(</span>sockaddr *<span style="color:#f92672">)</span>&amp;from, &amp;len<span style="color:#f92672">))</span> <span style="color:#f92672">==</span> -1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>719:        config-&gt;local_sock <span style="color:#f92672">=</span> local_sock;
</span></span></code></pre></div><p>The sustainable line here is on line <strong>719</strong> because in the others line the <code>config-&gt;local_sock</code> in parameters.  <br>
<img src="/images/stc/ch1-code_14.png" alt="alt">
And in this line we can see that a value (<code>local_sock</code>) is affected to <code>config-&gt;local_sock</code> and before this affectation the <code>prepare_socket</code> function is used and <code>local_sock</code> value is passed to parameter.
<img src="/images/stc/ch1-code_16.png" alt="alt"></p>
<p>In this code portion we can see that  <code>local_sock</code>  socket  is opened  and the port is assigned to <code>in6 sockaddr_in6</code> address  <strong>struct</strong>.</p>
<p>The <code>RELAY_PORT</code> as <strong>547</strong> like value is specified  in <code>src/dhcp6relay/src/relay.h</code> .<br>
After observation you can conclude that the vulnerable <strong>source-to-sink</strong> path exists for any <strong>IPv6</strong>, non-link-local network interface address on port <strong>547</strong>.</p>
<h2 id="testing-the-exploit">Testing the Exploit</h2>
<p>However, confirming a vulnerability purely through code review won’t suffice. You need to build a working <strong>proof of concept</strong> that produces a controllable crash.<br>
To build the <strong>PoC</strong>, you need to first develop a test environment. Without a working build of the target to test your exploit against, you can’t confirm the vulnerability.<br>
It’s also helpful to be able to quickly debug your initial proof-of-concept exploits in case something breaks along the way.</p>
<p>I prefer to build container images to encapsulate <strong>PoCs</strong> because it provides a consistent environment to experiment in and makes it portable for
others to verify the exploit.
We need <code>Docker</code> / <code>Podman</code> for do this.
But before we need to know how to build the program locally before to build her image and run the container.</p>
<p>For building the program check the README and install all dependency, but it&rsquo;s probably to meet other problem during building. So hesitate to copy, paste
the error on google .
When run <code>make</code> we see this:</p>
<h3 id="first-problem">First problem</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#12 0.287 src/relay.cpp:3:10: fatal error: event.h: No such file or directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#f92672">&lt;</span>event.h<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^~~~~~~~~</span>
</span></span><span style="display:flex;"><span>compilation terminated.
</span></span></code></pre></div><p>This error meaning you need to install a shared library that <code>dhcp6relay</code> depends on.<br>
For solve that  a simple  <code>apt install libevent-dev</code>.</p>
<h3 id="second-problem">Second Problem</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#11 0.328 src/relay.cpp:10:10: fatal error: configdb.h: No such file or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>directory
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">#</span>include <span style="color:#e6db74">&#34;configdb.h&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^~~~~~~~~~~~</span>
</span></span><span style="display:flex;"><span>compilation terminated.
</span></span></code></pre></div><p>Searching for <code>configdb.h</code> shows that it belongs to the <code>sonic-swss-common</code>
library, which is referred to in the <code>-I</code> argument in the <strong>Makefile</strong>.<br>
For this new project we need to build ans install the package yourself, the process to install it is on the <code>README.md</code> file on <a href="https://github.com/sonic-net/sonic-swss-common">sonic-swss-common</a> .</p>
<h3 id="third-problem">Third Problem</h3>
<p>After resolve all this dependency  on <code>dhcp6relay</code>, we see another problem when  we run :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>terminate called after throwing an instance of <span style="color:#960050;background-color:#1e0010">&#39;</span>std<span style="color:#f92672">::</span>system_error<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">what</span>()<span style="color:#f92672">:</span> Unable to connect to <span style="color:#a6e22e">redis</span> (unix<span style="color:#f92672">-</span>socket)<span style="color:#f92672">:</span> Cannot assign requested
</span></span><span style="display:flex;"><span>address
</span></span><span style="display:flex;"><span>Aborted
</span></span></code></pre></div><p>It appears that dhcp6relay is attempting to connect to a Redis server. If
you analyze <code>configInterface.cpp</code>, one of the source files for <code>dhcp6relay</code>, you’ll
see that it checks the <code>DHCP_RELAY</code> table in the <code>CONFIG_DB</code> database for a <code>dhcpv6_servers</code> field name.</p>
<p><img src="/images/stc/ch1-code_16.png" alt="alt"></p>
<p>Further research into this configuration setting leads to documentation
written by a <code>SONiC</code> developer <a href="https://support.edge-core.com/hc/en-us/articles/8615164994201--Edgecore-SONiC-DHCPv6-Relay">SONiC-DHCPv6-Relay</a>  (He need a account) that contains the expected structure of this configuration setting in the database.</p>
<p>After resolving this requirement by adding the expected configuration
to the <strong>Redis</strong> database, <code>dhcp6relay</code> finally runs but it doesn’t bind to any interfaces because none of them contain <strong>non-link-local</strong> <strong>IPv6</strong> addresses, as
<code>prepare_socket</code> requires.</p>
<p>Rather than creating a brand new interface, you can piggyback off an existing one through a virtual local area network (<strong>VLAN</strong>), then add the required fixed <strong>IPv6</strong> addresses.<br>
By definition, link-local <strong>IPv6</strong> addresses fall in the range <code>fe80::/10</code>, and
thus any valid address within this range works.</p>
<h3 id="setup-">Setup ?</h3>
<p>File : <code>add_ipv6_addresses.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/etc/init.d/redis-server restart
</span></span><span style="display:flex;"><span>ip link add link eth0 name vlan type vlan id <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>ip -6 addr add fe80::20c:29ff:fe90:14c5/64 dev vlan
</span></span><span style="display:flex;"><span>ip -6 addr add 2a00:7b80:451:1::10/64 dev vlan
</span></span><span style="display:flex;"><span>ip link set vlan up
</span></span><span style="display:flex;"><span>redis-cli -n <span style="color:#ae81ff">4</span> HSET <span style="color:#e6db74">&#34;DHCP_RELAY|vlan&#34;</span> dhcpv6_servers <span style="color:#e6db74">&#34;fe80::20c:29ff:fe90:14c5/64&#34;</span>
</span></span></code></pre></div><p>The <code>Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install dependencies</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> apt update<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt install -y autoconf-archive build-essential dh-exec gdb git iproute2 libboost-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libboost-thread-dev libevent-dev libgmock-dev libgtest-dev libhiredis-dev libnl-3-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libnl-genl-3-dev libnl-nf-3-dev libnl-route-3-dev libpython2.7-dev libpython3-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>libtool pkg-config python3 redis-server swig3.0<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Check out repo</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/sonic-net/sonic-buildimage<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">sonic-buildimage</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git checkout bcf5388<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Build and install sonic-swss-common</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git submodule update --init src/sonic-swss-common<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">src/sonic-swss-common</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ./autogen.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ./configure<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> make<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> make install<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ldconfig<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Build dhcp6relay</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">../dhcp6relay</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;8s/$/ -g/&#39;</span> Makefile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;24s/.*/\t$(CC) $(CFLAGS) -o $(DHCP6RELAY_TARGET) $(OBJS) $(LIBS) $(LDFLAGS)/&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>Makefile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> make<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Configure redis</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;109s/# / /&#39;</span> /etc/redis/redis.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;109s/\/var\/run\/redis\/redis-server.sock/\/var\/run\/redis\/redis.sock/&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/etc/redis/redis.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;110s/# / /&#39;</span> /etc/redis/redis.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;110s/700/755/&#39;</span> /etc/redis/redis.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy add ipv6 address script</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> add_ipv6_addresses.sh add_ipv6_addresses.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x add_ipv6_addresses.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> exploit.py /tmp/exploit.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># copy add ipv6 address script</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> add_ipv6_addresses.sh add_ipv6_addresses.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x add_ipv6_addresses.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Place this <code>Dockerfile</code> in a folder with the <code>add_ipv6_addresses.sh</code> script.<br>
Now build and run it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker build -t dhcp6relay .
</span></span><span style="display:flex;"><span>$ docker run -it --cap-add<span style="color:#f92672">=</span>NET_ADMIN --sysctl net.ipv6.conf.all.disable_ipv6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> dhcp6relay
</span></span></code></pre></div><p>Finally, run the script and start <code>dhcp6relay</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@8928b41ace8c:/sonic-buildimage/src/dhcp6relay# ./add_ipv6_addresses.sh
</span></span><span style="display:flex;"><span>Stopping redis-server: redis-server.
</span></span><span style="display:flex;"><span>Starting redis-server: redis-server.
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>root@8928b41ace8c:/sonic-buildimage/src/dhcp6relay# ./dhcp6relay
</span></span></code></pre></div><h2 id="building-the-proof-of-concept">Building the Proof of Concept</h2>
<p>You must send <strong>bytes</strong> that match the <code>dhcpv6_relay_msg</code> and <code>dhcpv6_option</code>
structs, as <code>src/dhcp6relay/src/relay.h</code> defines :</p>
<p>The link_address and peer_address members of the dhcpv6_relay_msg struct
are of the in6_addr struct type, which is not a custom struct defined in relay.h
but instead a shared type from the Linux operating system itself
(see <a href="https://man7.org/linux/man-pages/man7/ipv6.7.html">ipv6 man</a>).<br>
This <strong>struct</strong> contains a single <code>unsigned char s6_addr[16]</code>  member.</p>
<p><img src="/images/stc/ch1-code_17.png" alt="alt">
Note that the <code>dhcpv6_relay_msg</code> struct definition includes the <code>PACKED</code> attribute, which means that the <strong>compiler</strong> doesn’t add <strong>padding</strong> between the
struct’s members to <strong>align</strong> with <strong>memory</strong> boundaries.
<img src="/images/stc/ch1-code_18.png" alt="alt">
Without this <strong>attribute</strong>, the <strong>compiler</strong> might, for example, add 3 or 7 <strong>bytes</strong> between <code>msg_type</code> and <code>hop_count</code> to align with 4- or 8-<strong>byte</strong> boundaries, depending on whether the target is a <strong>32 or 64-bit</strong> system.</p>
<p>After confirming the data structures, recall the specific <strong>requirements</strong> for
these <strong>bytes</strong> to reach the <strong>vulnerable sink</strong>:</p>
<ul>
<li>When parsed into a <code>dhcpv6_msg</code> struct, the payload’s <code>msg_type</code> member must equal <code>DHCPv6_MESSAGE_TYPE_RELAY_REPL</code> .</li>
<li>The payload must include at least one dhcpv6_option struct after the
dhcpv6_relay_msg struct. (See <strong>Packet Schema</strong> )</li>
<li>When parsed into a <code>dhcpv6_option</code> struct, the <code>option_code</code> member
must equal <code>OPTION_RELAY_MSG</code> (9).</li>
</ul>
<p>You can re-create the <strong>bytes</strong> matching these <strong>requirements</strong> using the <strong>socket</strong>
and struct <strong>libraries</strong>. In particular, the <strong>pack</strong> function converts values (such as strings or integers)</p>
<p>The <strong>sink-to-source analysis</strong> revealed that the <strong>vulnerability</strong> lay in an overly
large <code>option_length</code> being used as the size of a <code>memcpy</code> to a <code>4,096-byte</code> destination <strong>buffer</strong>, so set <code>option_length</code> to the maximum <strong>65535</strong> value and add additional <strong>overflow bytes</strong> to the end of the payload. Since <code>dhcp6relay</code> converts the
values of <code>option_code</code> and <code>option_length</code> from network to host byte order, convert these values to network byte order first using <code>socket.htons</code>.</p>
<p>Next, rebuild the container image and start a new session:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker build -t dhcp6relay .
</span></span><span style="display:flex;"><span>$ docker run -it --cap-add<span style="color:#f92672">=</span>NET_ADMIN --sysctl net.ipv6.conf.all.disable_ipv6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> dhcp6relay
</span></span></code></pre></div><pre tabindex="0"><code class="language-docker-bash" data-lang="docker-bash">root@743a13d9862c:/sonic-buildimage/src/dhcp6relay# ./add_ipv6_addresses.sh
Stopping redis-server: redis-server.
Starting redis-server: redis-server.
(integer) 1
root@743a13d9862c:/sonic-buildimage/src/dhcp6relay# ./dhcp6relay
</code></pre><p>Start a second interactive session by listing the running containers and
starting bash in the current one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker exec -it 743a13d9862c bash
</span></span><span style="display:flex;"><span>root@743a13d9862c:/sonic-buildimage/src/dhcp6relay# python3 /tmp/exploit.py
</span></span></code></pre></div><p>You should observe a segmentation fault in your first session when you
run <code>dhcp6relay</code>:</p>
<pre tabindex="0"><code class="language-docker-bash" data-lang="docker-bash">root@743a13d9862c:/sonic-buildimage/src/dhcp6relay# ./dhcp6relay
Segmentation fault
</code></pre><p>To perform a quick triage of the crash, debug <code>dhcp6relay</code> using <code>gdb</code> , run the program on <code>gdb</code> with <code>run</code> command and check where the <strong>vulnerability</strong> appears with <code>backtrace</code>.<br>
Reviewing each step in discovering <code>CVE-2022-0324</code> demonstrated the <strong>key</strong> principle of selection in the <strong>sink-to-source</strong> tactic.</p>

    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    
    <img class="about__logo" src="https://0xswitch.fr//static/img/gif/main-1.gif" alt="Logo">
<h1 class="about__title">Tedsig42</h1>
<p class="about__description">Another infosec enthusiast blog</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/Tednoob17" rel="me" aria-label="GitHub" title="GitHub"><i class="fab fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://twitter.com/Tedsig42" rel="me" aria-label="Twitter" title="Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://instagram.com/tedsig_art" rel="me" aria-label="Instagram" title="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://linkedin.com/in/ted-kouhouenou" rel="me" aria-label="LinkedIn" title="LinkedIn"><i class="fab fa-linkedin" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    <p>Summary of Chapter 1</p>
    
        <p>
            By Tedsig42, 
            2025-08-03
        </p>
    

    

                </div>
            </section>

            <footer class="page__footer">
<p class="copyright"></p>
<p class="advertisement">Easy peasy ⚡<br>by Tedsig42</p>
</footer>

        </div>
    </body>

</html>
