<title>{{ with .Title }}{{ . }} &ndash; {{end}}{{ .Site.Title }}</title>
{{ with .Site.Params.about }}<meta name="description" content="{{ .description }}">{{ end }}

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>
{{ if .Site.Params.noindex }}<meta name="robots" content="noindex" /> {{ end }}

<!-- FontAwesome <https://fontawesome.com/> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Academicons <https://jpswalsh.github.io/academicons/> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- risotto theme -->
<link rel="stylesheet" href="{{ printf "css/palettes/%s.css" (.Site.Params.theme.palette | default "base16-dark") | absURL }}" id="theme-css">
<link rel="stylesheet" href="{{ "css/risotto.css" | absURL }}">
<link rel="stylesheet" href="{{ "css/custom.css" | absURL }}">

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Theme Toggle
  const themeToggle = document.getElementById('theme-toggle');
  const themeCss = document.getElementById('theme-css');
  const darkTheme = "tokyo-night-dark";
  const lightTheme = "tokyo-night-light";

  // Check storage
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
     themeCss.href = themeCss.href.replace(/(.*css\/palettes\/)(.*)(\.css)/, '$1' + savedTheme + '$3');
  }

  if (themeToggle) {
    themeToggle.addEventListener('click', function(e) {
      e.preventDefault();
      const currentHref = themeCss.href;
      const isDark = currentHref.includes(darkTheme) || currentHref.includes('dark');
      const newTheme = isDark ? lightTheme : darkTheme;

      themeCss.href = themeCss.href.replace(/(.*css\/palettes\/)(.*)(\.css)/, '$1' + newTheme + '$3');
      localStorage.setItem('theme', newTheme);
    });
  }

  // Search
  const searchTrigger = document.getElementById('search-trigger');
  const searchOverlay = document.getElementById('search-overlay');
  const searchClose = document.getElementById('search-close');
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  let searchIndex = null;
  let isLoading = false;

  const performSearch = (query) => {
    if (!searchIndex || query.length < 2) {
        searchResults.innerHTML = '';
        return;
    }

    const results = searchIndex.filter(item => {
        const title = item.title ? item.title.toLowerCase() : '';
        const content = item.content ? item.content.toLowerCase() : '';
        return title.includes(query) || content.includes(query);
    });

    let html = '';
    if (results.length > 0) {
        html = '<ul style="list-style: none; padding: 0;">';
        results.slice(0, 10).forEach(result => {
             // Create snippet
             let snippet = "";
             if (result.content) {
                 const lowerContent = result.content.toLowerCase();
                 const idx = lowerContent.indexOf(query);
                 if (idx !== -1) {
                     const start = Math.max(0, idx - 40);
                     const end = Math.min(result.content.length, idx + query.length + 40);
                     snippet = result.content.substring(start, end);
                     // Simple highlight
                     const re = new RegExp(query, 'gi');
                     snippet = snippet.replace(re, match => `<mark style="background-color: #0f0; color: #000;">${match}</mark>`);
                     snippet = "..." + snippet + "...";
                 } else {
                     snippet = result.content.substring(0, 100) + "...";
                 }
             }

            html += `<li style="margin-bottom: 15px;">
                <a href="${result.permalink}" style="color: #61bfff; font-size: 1.2em; text-decoration: none; font-weight: bold; display: block;">${result.title}</a>
                <div style="color: #ccc; font-size: 0.9em; margin-top: 5px;">${snippet}</div>
            </li>`;
        });
        html += '</ul>';
    } else {
        html = '<p>No results found.</p>';
    }
    searchResults.innerHTML = html;
  };

  if (searchTrigger) {
    searchTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        searchOverlay.style.display = 'block';
        searchInput.focus();

        if (!searchIndex && !isLoading) {
            isLoading = true;
            searchResults.innerHTML = '<p style="color: #888;">Loading search index...</p>';
            
            // Use relURL to ensure it works on localhost and subpaths
            fetch('{{ "index.json" | relURL }}')
                .then(response => {
                    if (!response.ok) {
                         throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    searchIndex = data;
                    isLoading = false;
                    searchResults.innerHTML = '';
                    if (searchInput.value.length >= 2) {
                        performSearch(searchInput.value.toLowerCase());
                    }
                })
                .catch(error => {
                    console.error('Error fetching search index:', error);
                    isLoading = false;
                    searchResults.innerHTML = '<p style="color: red;">Error loading search index. Check console.</p>';
                });
        }
    });
  }

  if (searchClose) {
    searchClose.addEventListener('click', function() {
        searchOverlay.style.display = 'none';
    });
  }
  
  // Close on Escape key
  document.addEventListener('keydown', function(e) {
      if (e.key === "Escape" && searchOverlay.style.display === 'block') {
          searchOverlay.style.display = 'none';
      }
  });

  if (searchInput) {
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        performSearch(query);
    });
  }
});
</script>

<!-- favicon -->
{{ if .Site.Params.favicon }}
<link rel="icon" href="{{ .Site.Params.favicon | absURL }}">
{{ else }}
{{ if os.FileExists "static/favicon.ico" }}<link rel="icon" href="{{ "favicon.ico" | absURL }}">{{ end }}
{{ end }}
